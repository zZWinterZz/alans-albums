{% extends 'base.html' %}
{% load static %}
{% block title %}Store listings{% endblock %}

{% block content %}
<div class="container">
  <h1 class="mt-4">Store listings</h1>
  <div class="list-group">
    {% for l in listings %}
      <div class="list-group-item bg-surface">
        <div class="card-body p-3">


          <div class="listing-card-row row">
            <!-- Outer grid: thumb | left-column (title/formats/year/notes) | right-column (price/stock/save/featured/edit) -->
            <div class="listing-col-thumb col-auto">
              <img src="{% if l.thumb %}{{ l.thumb }}{% else %}{% static 'images/Alansalbums.png' %}{% endif %}" alt="" class="thumb-img">
              {% if l.featured and l.stock != 0 %}
                <!-- mobile-only featured badge under thumbnail -->
                <div class="badge-mobile d-block d-sm-none mt-1 text-center">
                  <span class="badge bg-primary text-white">Featured</span>
                </div>
              {% endif %}
            </div>

            <div class="listing-col-left col">
              <div class="listing-left-grid">
              <div class="grid-title fw-semibold text-truncate text-primary">{{ l.artist }} — {{ l.title }} {% if l.featured and l.stock != 0 %}<span class="badge bg-primary text-white d-none d-sm-inline">Featured</span>{% endif %}</div>
              <div class="grid-formats small">{{ l.formats }}</div>
              <div class="grid-year small">{{ l.year }}{% if l.country %} · {{ l.country }}{% endif %}</div>
              </div>
            </div>

            <div class="listing-col-right col-auto">
              <div class="listing-right-grid">
              <form method="post" action="{% url 'listing_quick_update' l.pk %}" class="quick-edit" style="display:contents;">{% csrf_token %}
                <div class="grid-price">
                  <label class="form-label small mb-0">Price</label>
                  <input name="price" type="number" step="0.01" class="form-control form-control-sm" value="{% if l.price %}{{ l.price }}{% endif %}">
                </div>
                <div class="grid-stock">
                  <label class="form-label small mb-0">Stock</label>
                  <input name="stock" type="number" class="form-control form-control-sm" value="{% if l.stock is not None %}{{ l.stock }}{% endif %}">
                </div>
                <div class="grid-save">
                  <button class="btn btn-sm button-primary">Save</button>
                </div>
              </form>

              <div class="grid-notes">
                {% if l.release_notes %}
                  <div class="position-relative notes-container">
                    <button class="btn btn-sm button-primary notes-toggle" type="button" data-release-id="manage-{{ l.pk }}" data-overlay-id="manage-notes-{{ l.pk }}" aria-controls="manage-notes-{{ l.pk }}">Notes</button>
                    <div class="notes-overlay d-none" id="manage-notes-{{ l.pk }}" data-release-pk="{{ l.pk }}">
                      <div class="card card-body small text-primary">{{ l.release_notes }}</div>
                    </div>
                  </div>
                {% endif %}
              </div>

              <div class="grid-featured text-center">
                <form method="post" action="{% url 'listing_toggle_featured' l.pk %}" class="feature-toggle-form">{% csrf_token %}
                  {% if l.stock == 0 %}
                    <label class="form-label small mb-1" for="id_featured_list_{{ l.pk }}">Featured</label>
                    <div class="form-check form-switch mb-0 d-flex align-items-center justify-content-center">
                      <input class="form-check-input" type="checkbox" id="id_featured_list_{{ l.pk }}" name="featured" disabled aria-disabled="true">
                    </div>
                  {% else %}
                    <label class="form-label small mb-1" for="id_featured_list_{{ l.pk }}">Featured</label>
                    <div class="form-check form-switch mb-0 d-flex align-items-center justify-content-center">
                      <input class="form-check-input" type="checkbox" id="id_featured_list_{{ l.pk }}" name="featured" {% if l.featured %}checked{% endif %}>
                    </div>
                  {% endif %}
                </form>
              </div>

              <div class="grid-edit">
                <a href="{% url 'listing_edit' l.pk %}" class="btn btn-sm button-primary">Edit</a>
              </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="list-group-item">No listings yet.</div>
    {% endfor %}
  </div>
</div>
  <script>
    // Auto-submit feature toggle forms when the switch changes
    (function(){
      document.addEventListener('change', function(e){
        const input = e.target;
        if(!input) return;
        if(input.name === 'featured' && input.closest && input.closest('.feature-toggle-form')){
          const form = input.closest('.feature-toggle-form');
          // create a hidden input to ensure unchecked boxes submit as unchecked
          // we rely on the server to interpret presence/absence of 'featured'
          try{ form.submit(); }catch(err){ console.warn('Feature toggle submit failed', err); }
        }
      });
    })();
  </script>
  <style>
    /* Outer row using Bootstrap row/cols; nested grids live inside columns for responsive control */
    .listing-card-row { align-items: start; }
    .listing-col-thumb .thumb-img { display:block; width:72px; height:72px; object-fit:cover; border-radius:4px; }

  /* Left column is a nested grid with taller rows; right column is compact */
  .listing-left-grid { display: grid; gap: 0.25rem; grid-auto-rows: minmax(20px, auto); }
  .listing-right-grid { display: grid; gap: 0.25rem; grid-auto-rows: minmax(28px, auto); align-items: center; justify-items: end; }

  /* Allow left column to shrink inside the Bootstrap row/flexbox so right column stays visible */
  .listing-col-left { min-width: 0; overflow: visible; }
  /* Allow title text to wrap by default; desktop media-query will still apply a 2-line clamp */
  .listing-col-left .grid-title { overflow: visible; text-overflow: unset; white-space: normal; overflow-wrap: anywhere; }
  /* Allow formats text to wrap instead of truncating on small screens */
  .listing-col-left .grid-formats { white-space: normal; overflow-wrap: anywhere; word-break: break-word; }
  /* keep right column fixed and its items compact */
  .listing-col-right { flex: 0 0 auto; display: flex; align-items: center; gap: 0.5rem; }
  .listing-col-thumb { flex: 0 0 auto; }

    /* Move the actual right column element to the far right of the row */
    .listing-col-right { margin-left: auto; }

    /* Desktop layout tweaks */
    @media (min-width: 576px) {
  /* Left column should take remaining space on desktop */
  .listing-col-left { flex: 1 1 auto; width: auto; min-width: 0; }
      .listing-col-left .grid-title {
        display: -webkit-box; 
        -webkit-line-clamp: 2; 
        line-clamp: 2;
        -webkit-box-orient: vertical; 
        overflow: hidden; 
        text-overflow: ellipsis; 
        white-space: normal;
        word-break: break-word;
      }
      .listing-col-right { width: 220px; }
      .listing-right-grid { justify-items: end; grid-auto-flow: column; grid-auto-columns: max-content; align-items: center; gap: 0.5rem; }
      .listing-right-grid .grid-price, .listing-right-grid .grid-stock, .listing-right-grid .grid-save, .listing-right-grid .grid-featured, .listing-right-grid .grid-edit { display: inline-block; }

      /* Desktop placement for right-grid: two rows */
      .listing-right-grid { display: grid; grid-template-columns: max-content max-content max-content; grid-template-rows: auto auto;align-items: center; gap: 0.5rem; margin-top: -20px; }
      .listing-right-grid .grid-price { grid-column: 1; grid-row: 1; margin-bottom: 25px; }
      .listing-right-grid .grid-stock { grid-column: 2; grid-row: 1; margin-bottom: 25px; }
      .listing-right-grid .grid-save { grid-column: 3; grid-row: 1; }
      .listing-right-grid .grid-notes { grid-column: 1; grid-row: 2; margin-top: -20px;}
      .listing-right-grid .grid-featured { grid-column: 2; grid-row: 2;margin-top: -20px; }
      .listing-right-grid .grid-edit { grid-column: 3; grid-row: 2; margin-top: -20px;}
    }

    /* Mobile: thumbnail left, left-column text spans, right actions flow below in columns */
    @media (max-width: 575.98px) {
      .listing-col-thumb .thumb-img { width:40px; height:40px; }
            .listing-right-grid .grid-price {margin-bottom: 25px; }
      .listing-right-grid .grid-stock {margin-bottom: 25px; margin-left: 10px; }
      .listing-left-grid { grid-auto-rows: minmax(32px, auto); margin-left: -1rem;}
      .listing-right-grid { grid-auto-flow: row; grid-auto-rows: minmax(28px, auto); justify-items: stretch; display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.35rem; margin-right: 10vw; }
      .grid-price input, .grid-stock input { width: 100%; }
    }

    /* Ensure thumb and quick-edit inputs keep constrained sizes on desktop */
    .listing-col-thumb .thumb-img { width:72px !important; height:72px !important; }
    .grid-price input.form-control, .grid-price .form-control { width:66px; max-width:66px; }
    .grid-stock input.form-control, .grid-stock .form-control { width:50px; max-width:50px; }
      /* Remove native number input spin buttons for the price field (scoped to grid-price) */
      .grid-price input[type="number"]::-webkit-outer-spin-button,
      .grid-price input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .grid-price input[type="number"] {
        -moz-appearance: textfield; /* Firefox */
        appearance: textfield;
      }
    /* On very small screens, inputs should expand to the cell width */
    @media (max-width: 575.98px) {
    .grid-price input.form-control, .grid-price .form-control { width: 66px; max-width:66px; }
    .grid-stock input.form-control, .grid-stock .form-control { width:50px; max-width:50px; }
    }

    /* Tighten spacing between the Featured label and the switch */
    .listing-right-grid .grid-featured .form-label { margin-bottom: 0.15rem; }
    .listing-right-grid .grid-featured .form-check { margin-top: -0.5rem; }
  </style>
  {% endblock %}
