{% extends 'base.html' %}
{% block title %}Create Listing{% endblock %}

{% block content %}
<div class="container">
  <h1 class="mt-4">Create Listing</h1>
  <style>
    /* Price displayed with £ inside the input field */
    .price-with-pound { position: relative; display: inline-block; max-width: 180px; }
    .price-with-pound .pound {
      position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
      color: var(--text-primary); pointer-events: none; opacity: 0.95;
      font-weight: 500; z-index: 2; font-size: 0.95rem;
    }
    .price-with-pound .price-input,
    .price-with-pound input {
      padding-left: 52px !important; /* ensure room for the pound symbol */
      background: transparent; color: var(--text-primary); border: 1px solid var(--link-accent); border-radius: .375rem; min-width: 0; box-sizing: border-box; position: relative; z-index: 1;
      font-size: 0.95rem;
    }
  /* labels include colon explicitly in markup */
    /* remove-thumb button on image previews: make visible over photos */
    .create-thumb-remove {
      background: rgba(0,0,0,0.66);
      color: #fff;
      border: none !important;
      padding: 0 8px;
      line-height: 1;
      font-size: 1.12rem;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.35);
      z-index: 5;
      transform: translateZ(0);
    }
  </style>
  <form id="create-listing-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="mb-2">
          <label class="form-label">Artist:</label>
          <input name="artist" value="{{ artist }}" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Title:</label>
          <input name="title" value="{{ title }}" class="form-control">
        </div>
        <div class="mb-2 row">
            <div class="col">
            <label class="form-label">Year:</label>
            <input name="year" value="{{ year }}" class="form-control">
          </div>
          <div class="col">
            <label class="form-label">Country:</label>
            <input name="country" value="{{ country }}" class="form-control">
          </div>
        </div>
        <div class="mb-2">
          <label class="form-label">Catalog Number:</label>
          <input name="catalog_number" value="{{ catalog_number }}" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Formats:</label>
          <textarea name="formats" class="form-control" rows="3">{{ formats }}</textarea>
        </div>
        <div class="mb-2">
          <div class="row g-2 align-items-center">
            <div class="col-auto">
              {% if thumb %}
                <img src="{{ thumb }}" style="width:120px;object-fit:cover;border-radius:4px" alt="cover preview">
              {% endif %}
            </div>
            <div class="col">
              <label class="form-label">Cover image URL (thumb)</label>
              <input name="thumb" value="{{ thumb }}" class="form-control" placeholder="https://...">
            </div>
          </div>
        </div>
        <div class="mb-2">
          <label class="form-label">Notes:</label>
          <textarea name="release_notes" class="form-control" rows="4">{{ release_notes }}</textarea>
        </div>
        <div class="mb-2">
          <label class="form-label">Upload images:</label>
          <input type="file" name="images" id="id_images_create" multiple class="form-control">
          <div id="create-images-preview" class="d-flex gap-2 flex-wrap mt-2"></div>
        </div>
        <div class="row mt-3">
          <div class="col">
            <div class="d-flex align-items-center gap-5">
              <label class="form-label mb-0">Price:</label>
              <div class="form-check form-switch mb-0 d-flex align-items-center">
                <input class="form-check-input me-2" type="checkbox" id="id_featured_create" name="featured">
                <label class="form-check-label mb-0" for="id_featured_create">Featured</label>
              </div>
            </div>
            <div class="price-with-pound mt-2" style="max-width:180px;">
              <span class="pound">£</span>
              <input name="price" value="{{ price }}" class="form-control price-input" aria-label="Price in pounds">
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
  <div class="d-flex gap-2 mt-3">
    <button class="button-primary" type="submit" form="create-listing-form">Create</button>
    <a href="{% url 'manage_discogs' %}" class="btn btn-secondary">Back to search</a>
  </div>
</div>
<script>
  (function(){
    const input = document.getElementById('id_images_create');
    const preview = document.getElementById('create-images-preview');
    if(!input || !preview) return;
    function makeThumb(file, index){
      const url = URL.createObjectURL(file);
      const wrap = document.createElement('div');
      wrap.className = 'position-relative';
      wrap.style.width = '84px';
      wrap.style.height = '84px';
      wrap.style.borderRadius = '6px';
      wrap.style.overflow = 'hidden';
      const img = document.createElement('img');
      img.src = url;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'btn btn-sm position-absolute create-thumb-remove';
      btn.style.top = '4px';
      btn.style.right = '4px';
      btn.innerText = '×';
      btn.addEventListener('click', function(){
        const dt = new DataTransfer();
        Array.from(input.files).forEach((f, i)=>{ if(i!==index) dt.items.add(f); });
        input.files = dt.files;
        render();
      });
      wrap.appendChild(img);
      wrap.appendChild(btn);
      return wrap;
    }
    function render(){
      preview.innerHTML = '';
      Array.from(input.files).forEach((f, i)=> preview.appendChild(makeThumb(f,i)));
    }
    input.addEventListener('change', render);
  })();
</script>
{% endblock %}
