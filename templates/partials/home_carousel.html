{% load static %}
<div id="home-carousel" class="carousel slide w-100 my-4" data-bs-ride="carousel" style="height:80vh;">
  <div class="carousel-inner h-100">
    <div class="carousel-item active">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/alansecurity.jpg' %}" class="d-block carousel-img" alt="Alan Security">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/alansecurity2.jpg' %}" class="d-block carousel-img" alt="Alan Security 2">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/badgesandguitars.jpg' %}" class="d-block carousel-img" alt="Badges and Guitars">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/cds.jpg' %}" class="d-block carousel-img" alt="CDs">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/covers.jpg' %}" class="d-block carousel-img" alt="Covers">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/logo.jpg' %}" class="d-block carousel-img" alt="Logo">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/manakinhead.jpg' %}" class="d-block carousel-img" alt="Manakin Head">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/morecovers.jpg' %}" class="d-block carousel-img" alt="More Covers">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/punkcovers.jpg' %}" class="d-block carousel-img" alt="Punk Covers">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/punkfest.jpg' %}" class="d-block carousel-img" alt="Punk Fest">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/punkfest2.jpg' %}" class="d-block carousel-img" alt="Punk Fest 2">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/raretapes.jpg' %}" class="d-block carousel-img" alt="Rare Tapes">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/records.jpg' %}" class="d-block carousel-img" alt="Records">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/tapewall.jpg' %}" class="d-block carousel-img" alt="Tape Wall">
      </div>
    </div>
    <div class="carousel-item">
      <div class="carousel-img-wrapper d-flex align-items-center justify-content-center h-100">
        <img src="{% static 'images/homepagecarousel/tshirts.jpg' %}" class="d-block carousel-img" alt="T-Shirts">
      </div>
    </div>
  </div>
  <button class="carousel-control-prev" type="button" data-bs-target="#home-carousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Previous</span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#home-carousel" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Next</span>
  </button>
<style>
  .carousel-inner {
    height: 100%;
    min-height: 220px;
  }
  /* Only make the active slide a flex container so other slides remain hidden and don't stack */
  .carousel-item {
    text-align: center;
  }
  /* Ensure each slide fills the carousel so the wrapper can center content */
  .carousel-item {
    height: 100%;
  }
  .carousel-img {
    width: auto;
    height: auto;
    object-fit: contain;
    object-position: center;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }
    /* Fill mode: images cover the slide area and are cropped to fit */
    .carousel-img-wrapper {
      position: absolute;
      inset: 0;
      overflow: hidden;
      display: grid;
      place-items: center;
      padding: 0;
      margin: 0;
    }
    .carousel-img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* fill */
      object-position: center; /* change to e.g. 'top' to favour top area */
      display: block;
    }
  @media (max-width: 768px) {
    #home-carousel { height: 48vh; }
  }
</style>
</div>
<script>
  (function() {
    function computeCarouselHeight() {
      var carousel = document.getElementById('home-carousel');
      if (!carousel) return;
      var imgs = Array.from(carousel.querySelectorAll('img.carousel-img'));
      if (!imgs.length) return;
      var carouselWidth = carousel.clientWidth;
      var maxImgDisplayWidth = Math.floor(carouselWidth * 0.8);
      var maxDisplayedHeight = 0;
      imgs.forEach(function(img) {
        var nw = img.naturalWidth || img.width || 0;
        var nh = img.naturalHeight || img.height || 0;
        if (!nw || !nh) return;
        // If image native width is smaller than max display width, it will display at native size (we don't upscale)
        var displayedW = Math.min(nw, maxImgDisplayWidth);
        var scale = displayedW / nw;
        var displayedH = Math.round(nh * scale);
        if (displayedH > maxDisplayedHeight) maxDisplayedHeight = displayedH;
      });
      if (maxDisplayedHeight === 0) {
        // fallback to current visible image height
        var activeImg = carousel.querySelector('.carousel-item.active img.carousel-img');
        maxDisplayedHeight = (activeImg && (activeImg.clientHeight || activeImg.naturalHeight)) || 300;
      }

      // Add vertical padding for controls and breathing room
      var desired = maxDisplayedHeight + 80;
      // Cap desired height to viewport proportions
      var capDesktop = Math.floor(window.innerHeight * 0.8);
      var capMobile = Math.floor(window.innerHeight * 0.48);
      if (window.innerWidth <= 768) {
        desired = Math.min(desired, capMobile);
        if (desired < 180) desired = 180;
      } else {
        desired = Math.min(desired, capDesktop);
      }

      carousel.style.height = desired + 'px';
      // ensure inner elements fill the carousel
      var fills = carousel.querySelectorAll('.carousel-inner, .carousel-item, .carousel-img-wrapper');
      fills.forEach(function(el) { el.style.height = '100%'; });
    }

    window.addEventListener('load', computeCarouselHeight);
    window.addEventListener('resize', computeCarouselHeight);
    document.addEventListener('DOMContentLoaded', function() {
      var carousel = document.getElementById('home-carousel');
      if (!carousel) return;
      // Recompute when slide finishes
      carousel.addEventListener('slid.bs.carousel', computeCarouselHeight);
      // Recompute as images load
      var imgs = carousel.querySelectorAll('img.carousel-img');
      imgs.forEach(function(img) {
        if (!img.complete) img.addEventListener('load', computeCarouselHeight);
      });
      // Initial compute after a short delay in case images are cached
      setTimeout(computeCarouselHeight, 120);
    });
  })();
</script>
