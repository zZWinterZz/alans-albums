{% extends 'base.html' %}
{% block title %}Edit listing{% endblock %}

{% block content %}
<div class="container listing-edit">
  <h1 class="mt-4">Edit listing</h1>
  <style>
    /* Scope tweaks to this page to keep layout stable across viewports */
    .listing-edit .card-body p { margin-bottom: .65rem; }
  .listing-edit .card-body label { display: block; margin-bottom: .5rem; }
    .listing-edit .card-body input[type="text"],
  .listing-edit .card-body input[type="number"],
  .listing-edit .card-body input[type="file"],
  .listing-edit .card-body select,
  .listing-edit .card-body textarea { width: 100%; }
  /* Ensure large textareas keep their height but match theme */
  .listing-edit .card-body textarea{ min-height:140px; }
  /* also apply to elements rendered without specific input types (e.g., selects generated by Django) */
  /* Apply form-control styles but avoid styling checkboxes so Bootstrap's switch UI works */
  .listing-edit .card-body .form-control,
  .listing-edit .card-body input:not([type=checkbox]):not([type=file]),
  .listing-edit .card-body textarea,
  .listing-edit .card-body select{ background:transparent !important; color:var(--text-primary) !important; border:1px solid var(--text-primary) !important; }
    /* Keep the thumbnail grid compact */
  .listing-edit .existing-thumb { width:72px; height:72px; object-fit:cover; border-radius:4px; border:1px solid var(--border, rgba(0,0,0,0.06)); background:var(--card-surface); box-shadow:0 2px 6px rgba(0,0,0,0.04); }
  /* visually hide native checkbox but keep it accessible */
  .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;margin:0;padding:0}
  .thumb-item{cursor:pointer}
  .thumb-item .thumb-overlay{position:absolute;inset:6px;border-radius:6px;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:all .12s ease}
  .thumb-item .thumb-overlay i{color:var(--background);font-size:18px}
  .thumb-item.selected .thumb-overlay{background:color-mix(in srgb, var(--link-accent) 40%, transparent);opacity:1;border:2px solid var(--link-accent);box-shadow:0 6px 18px rgba(0,0,0,0.12)}
  /* Price displayed with £ inside the input field */
  .price-with-pound { position: relative; display: inline-block; max-width: 180px; }
    .price-with-pound .pound { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-primary); pointer-events: none; opacity: 0.95; font-weight: 500; z-index:2; font-size:0.95rem; }
    .price-with-pound .price-input,
      .price-with-pound input { padding-left: 52px !important; background: transparent; color: var(--text-primary); border: 1px solid var(--text-primary); border-radius: .375rem; min-width: 0; box-sizing: border-box; position: relative; z-index:1; font-size:0.95rem; }
  /* Stronger parity with create page: ensure text input spacing and stacking match exactly */
  .price-with-pound input.price-input{
    padding-left:52px !important;
    font-size:0.95rem !important;
    /* inherit default line-height so vertical padding matches the create form */
    box-sizing:border-box !important;
    background:transparent !important;
    z-index:1 !important;
  }
  .price-with-pound .pound{ z-index:3 !important; left:14px !important; }
  /* remove-thumb button styling (used for JS previews) */
  .create-thumb-remove{ background: rgba(0,0,0,0.66); color:#fff; border:none!important; padding:0 8px; line-height:1; font-size:1.05rem; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.35); z-index:5; }
  /* labels include colon explicitly in markup; ensure border colours match create */
  .listing-edit .card-body .form-control,
  .listing-edit .card-body input:not([type=checkbox]):not([type=file]),
  .listing-edit .card-body textarea,
  .listing-edit .card-body select{ border-radius: .375rem; }
  </style>
  <form id="edit-listing-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="row">
          <div class="col-12">
            {# Render all fields except featured, price, thumb, release_notes, condition, year, country and formats #}
            {% for field in form.visible_fields %}
              {% if field.name != 'featured' and field.name != 'price' and field.name != 'thumb' and field.name != 'release_notes' and field.name != 'condition' and field.name != 'year' and field.name != 'country' and field.name != 'formats' and field.name != 'catalog_number' %}
                <div class="mb-2">
                  <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                  {{ field }}
                  {% if field.help_text %}<div class="small text-muted">{{ field.help_text }}</div>{% endif %}
                  {% if field.errors %}
                    <div class="text-danger small">{{ field.errors.as_text }}</div>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}

            {# Year and Country side-by-side (two columns) #}
            <div class="mb-2 row">
              <div class="col">
                {{ form.year.label_tag }}
                <input type="text" name="{{ form.year.html_name }}" id="{{ form.year.id_for_label }}" value="{{ form.year.value }}" class="form-control">
                {% if form.year.help_text %}<div class="small text-muted">{{ form.year.help_text }}</div>{% endif %}
                {% if form.year.errors %}<div class="text-danger small">{{ form.year.errors.as_text }}</div>{% endif %}
              </div>
              <div class="col">
                {{ form.country.label_tag }}
                <input type="text" name="{{ form.country.html_name }}" id="{{ form.country.id_for_label }}" value="{{ form.country.value }}" class="form-control">
                {% if form.country.help_text %}<div class="small text-muted">{{ form.country.help_text }}</div>{% endif %}
                {% if form.country.errors %}<div class="text-danger small">{{ form.country.errors.as_text }}</div>{% endif %}
              </div>
            </div>

            {# Catalog Number (kept full width) #}
            {% if form.catalog_number %}
            <div class="mb-2">
              <label class="form-label">Catalog Number:</label>
              {{ form.catalog_number }}
              {% if form.catalog_number.help_text %}<div class="small text-muted">{{ form.catalog_number.help_text }}</div>{% endif %}
              {% if form.catalog_number.errors %}<div class="text-danger small">{{ form.catalog_number.errors.as_text }}</div>{% endif %}
            </div>
            {% endif %}

            {# Formats (smaller textarea to match create) #}
            <div class="mb-2">
              {{ form.formats.label_tag }}
              <textarea name="{{ form.formats.html_name }}" id="{{ form.formats.id_for_label }}" class="form-control formats-small" rows="3" style="min-height:72px;">{{ form.formats.value }}</textarea>
              {% if form.formats.help_text %}<div class="small text-muted">{{ form.formats.help_text }}</div>{% endif %}
              {% if form.formats.errors %}<div class="text-danger small">{{ form.formats.errors.as_text }}</div>{% endif %}
            </div>

            {# Cover image (thumb) - preview left, label above input on right #}
            <div class="mb-2">
              <div class="row g-2 align-items-center">
                <div class="col-auto">
                  {% if listing.thumb %}
                    <img src="{{ listing.thumb }}" style="width:120px;object-fit:cover;border-radius:4px" alt="cover preview">
                  {% endif %}
                </div>
                <div class="col">
                  <label class="form-label">Cover image URL (thumb):</label>
                  {{ form.thumb }}
                </div>
              </div>
            </div>

            {# Notes come after the cover block #}
            <div class="mb-2">
              <label class="form-label">Notes:</label>
              {{ form.release_notes }}
              {% if form.release_notes.help_text %}<div class="small text-muted">{{ form.release_notes.help_text }}</div>{% endif %}
              {% if form.release_notes.errors %}<div class="text-danger small">{{ form.release_notes.errors.as_text }}</div>{% endif %}
            </div>

            {# Upload images (placed here so it's near price/featured) #}
            <div class="mb-2">
              <label for="id_images" class="form-label">Upload images:</label>
              <input type="file" name="images" id="id_images" multiple class="form-control">
              <div id="edit-images-preview" class="d-flex gap-2 flex-wrap mt-2"></div>
            </div>

            <div class="row mt-3">
              <div class="col">
                <div class="d-flex align-items-center gap-5">
                  <label class="form-label mb-0">Price:</label>
                  <div class="form-check form-switch mb-0 d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" id="id_featured_edit" name="featured" {% if listing.featured %}checked{% endif %}>
                    <label class="form-check-label mb-0" for="id_featured_edit">Featured</label>
                  </div>
                </div>
                <div class="mt-2">
                  <div class="edit-price-group">
                    <div class="price-with-pound">
                      <span class="pound">£</span>
                      <input type="text" name="{{ form.price.html_name }}" id="{{ form.price.id_for_label }}" value="{{ form.price.value }}" class="form-control price-input" aria-label="Price in pounds">
                    </div>
                  </div>
                  {% if form.price.help_text %}<div class="small text-muted">{{ form.price.help_text }}</div>{% endif %}
                  {% if form.price.errors %}<div class="text-danger small">{{ form.price.errors.as_text }}</div>{% endif %}
                </div>
              </div>
            </div>

            {# Existing images moved below so the form is full-width like the create page #}
            {% if listing.images.all %}
            <div class="mb-3 mt-3">
              <label class="form-label">Existing images</label>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted">Select images to delete</small>
                <button type="submit" name="action" value="delete_selected" id="delete-selected-btn" class="btn btn-sm btn-danger" disabled>Delete selected</button>
              </div>
              <div class="d-flex gap-2 flex-wrap align-items-start">
                {% for img in listing.images.all %}
                  <div class="thumb-item text-center" style="width:84px; position:relative;">
                    <img src="{{ img.image.url }}" alt="" class="img-fluid existing-thumb">
                    <input class="delete-checkbox visually-hidden" type="checkbox" name="images_to_delete" value="{{ img.pk }}" id="del-img-{{ img.pk }}" aria-label="Select image {{ forloop.counter }} for deletion">
                    <span class="thumb-overlay" aria-hidden="true">
                      <i class="fa-solid fa-check"></i>
                    </span>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </form>
  <div class="d-flex gap-2 mt-3">
    <button type="submit" form="edit-listing-form" class="button-primary">Save</button>
    <a href="{% url 'listing_list' %}" class="btn btn-secondary">Cancel</a>
  </div>
</div>
<script>
  // Ensure form controls on this page follow the active theme.
  (function(){
    // Ensure form controls have the form-control class but avoid forcing inline styles
    const root = document.querySelector('.listing-edit .card');
    if(!root) return;
    const els = root.querySelectorAll('input:not([type=checkbox]):not([type=radio]), textarea, select');
    els.forEach(el=>{
      try{
        // don't set background or borderColor inline - let CSS/bootstrap decide so it matches create page
        el.classList.add('form-control');
      }catch(e){/* ignore */}
    });
  })();

  

  // Enable/disable delete selected button based on checkboxes
  (function(){
    const deleteBtn = document.getElementById('delete-selected-btn');
    if(!deleteBtn) return;
    const checkboxes = document.querySelectorAll('.delete-checkbox');
    function update(){
      const any = Array.from(checkboxes).some(c=>c.checked);
      deleteBtn.disabled = !any;
    }
    checkboxes.forEach(cb=>{
      const parent = cb.closest('.thumb-item');
      // init state class
      if(cb.checked && parent) parent.classList.add('selected');
      cb.addEventListener('change', function(){
        if(parent) parent.classList.toggle('selected', cb.checked);
        update();
      });
      // clicking the thumbnail toggles the checkbox
      if(parent){
        parent.addEventListener('click', function(e){
          // avoid toggling when clicking on the Delete Selected button or other controls
          if(e.target.closest('button')) return;
          cb.checked = !cb.checked;
          parent.classList.toggle('selected', cb.checked);
          update();
        });
      }
    });
    deleteBtn.addEventListener('click', function(e){
      if(!confirm('Are you sure you want to delete the selected images? This cannot be undone.')){
        e.preventDefault();
      }
    });
    update();
  })();

  // Image upload preview for edit page (matches create behaviour)
  (function(){
    const input = document.getElementById('id_images');
    const preview = document.getElementById('edit-images-preview');
    if(!input || !preview) return;
    function makeThumb(file, index){
      const url = URL.createObjectURL(file);
      const wrap = document.createElement('div');
      wrap.className = 'position-relative';
      wrap.style.width = '84px';
      wrap.style.height = '84px';
      wrap.style.borderRadius = '6px';
      wrap.style.overflow = 'hidden';
      const img = document.createElement('img');
      img.src = url;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-sm position-absolute create-thumb-remove';
      btn.style.top = '4px';
      btn.style.right = '4px';
      btn.innerText = '×';
      btn.addEventListener('click', function(){
        const dt = new DataTransfer();
        Array.from(input.files).forEach((f, i)=>{ if(i!==index) dt.items.add(f); });
        input.files = dt.files;
        render();
      });
      wrap.appendChild(img);
      wrap.appendChild(btn);
      return wrap;
    }
    function render(){
      preview.innerHTML = '';
      Array.from(input.files).forEach((f, i)=> preview.appendChild(makeThumb(f,i)));
    }
    input.addEventListener('change', render);
  })();
</script>
{% endblock %}
