{% extends 'base.html' %}
{% block title %}Edit listing{% endblock %}

{% block content %}
<div class="container listing-edit">
  <h1 class="mt-4">Edit listing</h1>
  <style>
    /* Scope tweaks to this page to keep layout stable across viewports */
    .listing-edit .card-body p { margin-bottom: .65rem; }
    .listing-edit .card-body label { display: block; margin-bottom: .25rem; }
  .listing-edit .card-body input[type="text"],
  .listing-edit .card-body input[type="number"],
  .listing-edit .card-body input[type="file"],
  .listing-edit .card-body select,
  .listing-edit .card-body textarea { width: 100%; background: transparent !important; color:var(--text-primary) !important; border:1px solid var(--link-accent, rgba(255,215,0,0.6)) !important; padding:.5rem .75rem; border-radius:.6rem; }
  /* Ensure large textareas keep their height but match theme */
  .listing-edit .card-body textarea{ min-height:140px; }
  /* also apply to elements rendered without specific input types (e.g., selects generated by Django) */
  .listing-edit .card-body .form-control,
  .listing-edit .card-body input,
  .listing-edit .card-body textarea,
  .listing-edit .card-body select{ background:transparent !important; color:var(--text-primary) !important; border-color:var(--link-accent) !important; }
    /* Keep the thumbnail grid compact */
  .listing-edit .existing-thumb { width:72px; height:72px; object-fit:cover; border-radius:4px; border:1px solid var(--border, rgba(0,0,0,0.06)); background:var(--card-surface); box-shadow:0 2px 6px rgba(0,0,0,0.04); }
  /* visually hide native checkbox but keep it accessible */
  .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;margin:0;padding:0}
  .thumb-item{cursor:pointer}
  .thumb-item .thumb-overlay{position:absolute;inset:6px;border-radius:6px;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:all .12s ease}
  .thumb-item .thumb-overlay i{color:var(--background);font-size:18px}
  .thumb-item.selected .thumb-overlay{background:color-mix(in srgb, var(--link-accent) 40%, transparent);opacity:1;border:2px solid var(--link-accent);box-shadow:0 6px 18px rgba(0,0,0,0.12)}
  </style>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="row">
          <div class="col-12 col-md-8">
            {{ form.as_p }}
            <div class="d-flex gap-2">
              <button type="submit" class="button-primary">Save</button>
              <a href="{% url 'listing_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="mb-3">
              <label for="id_images" class="form-label">Upload images (optional)</label>
              <input type="file" name="images" id="id_images" multiple class="form-control">
            </div>
            {% if listing.images.all %}
            <div class="mb-3">
              <label class="form-label">Existing images</label>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted">Select images to delete</small>
                <button type="submit" name="action" value="delete_selected" id="delete-selected-btn" class="btn btn-sm btn-danger" disabled>Delete selected</button>
              </div>
              <div class="d-flex gap-2 flex-wrap align-items-start">
                {% for img in listing.images.all %}
                  <div class="thumb-item text-center" style="width:84px; position:relative;">
                    <img src="{{ img.image.url }}" alt="" class="img-fluid existing-thumb">
                    <input class="delete-checkbox visually-hidden" type="checkbox" name="images_to_delete" value="{{ img.pk }}" id="del-img-{{ img.pk }}" aria-label="Select image {{ forloop.counter }} for deletion">
                    <span class="thumb-overlay" aria-hidden="true">
                      <i class="fa-solid fa-check"></i>
                    </span>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
<script>
  // Ensure form controls on this page follow the active theme.
  (function(){
    const root = document.querySelector('.listing-edit .card');
    if(!root) return;
    const els = root.querySelectorAll('input, textarea, select');
    els.forEach(el=>{
      try{
        el.style.background = 'transparent';
        el.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#111';
        el.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--link-accent') || 'rgba(0,0,0,0.06)';
        el.classList.add('form-control');
      }catch(e){/* ignore */}
    });
  })();

  // Enable/disable delete selected button based on checkboxes
  (function(){
    const deleteBtn = document.getElementById('delete-selected-btn');
    if(!deleteBtn) return;
    const checkboxes = document.querySelectorAll('.delete-checkbox');
    function update(){
      const any = Array.from(checkboxes).some(c=>c.checked);
      deleteBtn.disabled = !any;
    }
    checkboxes.forEach(cb=>{
      const parent = cb.closest('.thumb-item');
      // init state class
      if(cb.checked && parent) parent.classList.add('selected');
      cb.addEventListener('change', function(){
        if(parent) parent.classList.toggle('selected', cb.checked);
        update();
      });
      // clicking the thumbnail toggles the checkbox
      if(parent){
        parent.addEventListener('click', function(e){
          // avoid toggling when clicking on the Delete Selected button or other controls
          if(e.target.closest('button')) return;
          cb.checked = !cb.checked;
          parent.classList.toggle('selected', cb.checked);
          update();
        });
      }
    });
    deleteBtn.addEventListener('click', function(e){
      if(!confirm('Are you sure you want to delete the selected images? This cannot be undone.')){
        e.preventDefault();
      }
    });
    update();
  })();
</script>
{% endblock %}
