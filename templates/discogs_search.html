{% extends 'base.html' %}
{% block title %}Discogs Search{% endblock %}

{% block content %}
<div class="container">
  <h1 class="mt-4">Discogs Search</h1>

  <form method="get" class="mb-3">
    <div class="card mb-3">
      <div class="card-body p-2">
        <div class="row g-2">
          <div class="col-md-6">
            <input name="q" value="{{ query }}" class="form-control" placeholder="Search Discogs releases or artists" aria-label="Search Discogs">
          </div>
          <div class="col-md-2">
            <input name="year" value="{{ year }}" class="form-control" placeholder="Year" aria-label="Year">
          </div>
          <div class="col-md-2">
            <input name="format" value="{{ format }}" class="form-control" placeholder="Format (e.g. Vinyl)" aria-label="Format">
          </div>
          <div class="col-md-2">
            <input name="country" value="{{ country }}" class="form-control" placeholder="Country (e.g. UK)" aria-label="Country">
          </div>
          <div class="col-md-2">
            <button class="button-primary w-100" type="submit">Search</button>
          </div>
        </div>
      </div>
    </div>
  </form>

  {% if query and results is not None %}
    <h5>Results for “{{ query }}”</h5>
    {% if not has_token %}
      <div class="alert alert-warning">No Discogs token found. Set <code>DISCOGS_TOKEN</code> environment variable to enable API searches.</div>
    {% endif %}
    {% if results %}
      {# Preload the first result image to improve LCP when available #}
      {% if results.0.thumb %}
        <link rel="preload" as="image" href="{{ results.0.thumb }}">
      {% endif %}
      <div class="discogs-results">
        {% for r in results %}
          <div class="card mb-2" {% if r.release_id %}data-release-id="{{ r.release_id }}"{% endif %}>
            <div class="card-body p-3">
              <div class="result-grid">
                <div class="thumb">
                  {% if r.thumb %}
                    {% if forloop.counter0 == 0 or forloop.counter0 == 1 %}
                      <img src="{{ r.thumb }}" fetchpriority="high" class="result-thumb rounded" alt="{{ r.title }}">
                    {% else %}
                      <img src="{{ r.thumb }}" loading="lazy" decoding="async" class="result-thumb rounded" alt="{{ r.title }}">
                    {% endif %}
                  {% else %}
                    <div class="result-thumb bg-light d-flex align-items-center justify-content-center">No image</div>
                  {% endif %}
                </div>

                <div class="text-row1">
                  <p class="mb-0 small text-muted">{{ r.artist }}</p>
                  <p class="fw-semibold mb-1">{{ r.title }}</p>
                </div>

                <div class="text-row2">
                  <p class="mb-1 small">{{ r.year }}{% if r.country %} · {{ r.country }}{% endif %}</p>
                  {% if r.catalog_number %}
                    <p class="mb-1 small">Catalog: {{ r.catalog_number }}</p>
                  {% endif %}
                  <div class="formats-area small mb-1">
                    {% if r.formats_lines %}
                      {% for line in r.formats_lines %}
                        <span class="me-2">{{ line }}</span>
                      {% endfor %}
                    {% else %}
                      <span>{{ r.formats }}</span>
                    {% endif %}
                  </div>
                </div>

                <div class="actions-row">
                  <div class="row">
                      <div class="col text-start">
                        {% if r.release_id %}
                          <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm button-primary notes-toggle" type="button" data-release-id="{{ r.release_id }}" aria-expanded="false" aria-controls="notes-{{ r.release_id }}">Notes</button>
                            <a href="https://www.discogs.com/sell/history/{{ r.release_id }}" target="_blank" rel="noopener noreferrer" class="btn btn-sm button-primary">History</a>
                          </div>
                          <div class="notes-overlay d-none mt-1" id="notes-{{ r.release_id }}" data-release-pk="{{ r.release_id }}">
                            <div class="card card-body small"></div>
                          </div>
                        {% endif %}
                      </div>
                      <div class="col">&nbsp;</div>
                      <div class="col text-end">
                        <a href="{% url 'create_listing' %}?release_id={{ r.release_id }}{% if r.thumb %}&thumb={{ r.thumb|urlencode }}{% endif %}" class="btn btn-sm button-primary">Create</a>
                      </div>
                    </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      <nav aria-label="Search results pagination" class="mt-3">
        <ul class="pagination">
          {% if has_prev %}
            <li class="page-item">
              <a class="btn btn-sm button-primary" href="?q={{ query|urlencode }}&page={{ prev_page }}&year={{ year|urlencode }}&format={{ format|urlencode }}&country={{ country|urlencode }}">Previous</a>
            </li>
          {% endif %}

          {% if has_next %}
            <li class="page-item">
              <a class="btn btn-sm button-primary" href="?q={{ query|urlencode }}&page={{ next_page }}&year={{ year|urlencode }}&format={{ format|urlencode }}&country={{ country|urlencode }}">Next</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% else %}
      <div class="alert alert-info">No results found. Try a different query or check your Discogs token.</div>
    {% endif %}
  {% endif %}
  
</div>
{% endblock %}
{% block extra_js %}
<style>
  /* Thumbnails for the new list view: small square on the left */
  .discogs-results .result-thumb {
    display: block !important;
    width: 96px !important;
    height: 96px !important;
    object-fit: cover !important;
    flex: 0 0 96px !important;
  }
  /* Grid layout for each result: image spans rows 1-2 on the left; two text rows on right; actions across bottom */
  .discogs-results .result-grid {
    display: grid;
    grid-template-columns: 96px 1fr;
    grid-template-rows: auto auto auto;
    gap: 0.5rem 1rem;
    align-items: start;
  }
  .discogs-results .result-grid .thumb { grid-column: 1; grid-row: 1 / span 2; }
  .discogs-results .result-grid .text-row1 { grid-column: 2; grid-row: 1; }
  .discogs-results .result-grid .text-row2 { grid-column: 2; grid-row: 2; }
  .discogs-results .result-grid .actions-row { grid-column: 1 / -1; grid-row: 3; }
  /* Fallback for any other usages of result-thumb */
  img.result-thumb {
    display: block !important;
    width: 100% !important;
    height: 140px !important;
    object-fit: cover !important;
  }
  /* Notes overlay: will be mounted to document.body and positioned absolutely
     so it sits on top of the grid and doesn't change layout when opened */
  .notes-container { position: relative; }
  .notes-overlay {
    display: block; /* default; visibility controlled via d-none */
    max-height: 60vh;
    overflow: auto;
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    border-radius: 4px;
  }
  .notes-overlay .card-body { padding: 0.5rem; }
  /* when mounted to body, apply absolute positioning and high z-index */
  .notes-overlay.is-mounted {
    position: absolute;
    z-index: 1050;
  }
</style>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Notes overlay: mount to document.body and position so it doesn't change layout
  document.querySelectorAll('.notes-toggle').forEach(function(btn){
    // avoid double-initializing if a global handler (static/js/main.js) already mounted this button
    if(btn._notesInitialized) return;
    btn._notesInitialized = true;
    btn.addEventListener('click', async function(){
      const releaseId = btn.getAttribute('data-release-id');
      if(!releaseId) return;
      const overlay = document.getElementById('notes-' + releaseId);
      if(!overlay) return;
      const card = document.querySelector(`.card[data-release-id="${releaseId}"]`);
      const container = card ? card.querySelector('.notes-container') : null;

      const isHidden = overlay.classList.contains('d-none');
      if(!isHidden){
        // hide: remove mounted state, clear inline styles, put back into container
        overlay.classList.add('d-none');
        overlay.classList.remove('is-mounted');
        overlay.style.left = '';
        overlay.style.top = '';
        overlay.style.width = '';
        if(container) container.appendChild(overlay);
        btn.setAttribute('aria-expanded','false');
        // remove global handlers if present
        if(window._notesOutsideClick) {
          document.removeEventListener('click', window._notesOutsideClick);
          window._notesOutsideClick = null;
        }
        if(window._notesEscKey) {
          document.removeEventListener('keydown', window._notesEscKey);
          window._notesEscKey = null;
        }
        return;
      }

      // show: move overlay to body and position near the card
      overlay.classList.remove('d-none');
      overlay.classList.add('is-mounted');
      document.body.appendChild(overlay);
      btn.setAttribute('aria-expanded','true');

      // position overlay directly below the Notes button to avoid covering it
      try{
        const brect = btn.getBoundingClientRect();
        const padding = 8;
        const leftCandidate = brect.left + window.scrollX;
        // prefer aligning left with button, but keep inside viewport
        const maxAllowedLeft = window.scrollX + Math.max(document.documentElement.clientWidth, window.innerWidth) - 16;
        const left = Math.min(Math.max(padding, leftCandidate), maxAllowedLeft);
        const top = brect.bottom + window.scrollY + 6; // small gap below button
        // width: try to match card width but not too wide
        const cardWidth = card ? card.getBoundingClientRect().width : 360;
        const maxWidth = Math.min(Math.max(240, cardWidth), 720);
        overlay.style.left = `${left}px`;
        overlay.style.top = `${top}px`;
        overlay.style.width = `${maxWidth}px`;
      }catch(e){
        overlay.style.left = '8px';
        overlay.style.top = '8px';
        overlay.style.width = '420px';
      }

      // close when clicking outside or pressing Escape
      window._notesOutsideClick = function(ev){
        if(!overlay.contains(ev.target) && !btn.contains(ev.target)){
          overlay.classList.add('d-none');
          overlay.classList.remove('is-mounted');
          if(container) container.appendChild(overlay);
          btn.setAttribute('aria-expanded','false');
          document.removeEventListener('click', window._notesOutsideClick);
          window._notesOutsideClick = null;
          if(window._notesEscKey){ document.removeEventListener('keydown', window._notesEscKey); window._notesEscKey = null; }
        }
      };
      document.addEventListener('click', window._notesOutsideClick);
      window._notesEscKey = function(ev){ if(ev.key === 'Escape'){ if(!overlay.classList.contains('d-none')){ overlay.classList.add('d-none'); overlay.classList.remove('is-mounted'); if(container) container.appendChild(overlay); btn.setAttribute('aria-expanded','false'); } } };
      document.addEventListener('keydown', window._notesEscKey);

      // if already loaded, skip fetching
      if(overlay.dataset.loaded === '1') return;
      try{
        const resp = await fetch(`/manage/discogs/release_details/${releaseId}/`);
        if(!resp.ok) throw new Error('Network');
        const data = await resp.json();
        const body = overlay.querySelector('.card-body');
        if(body) {
          // if main.js has replaced notesToHtml helper, prefer innerHTML markup
          if(window.notesToHtml) body.innerHTML = window.notesToHtml(data.notes || '');
          else body.textContent = data.notes || '';
        }
        overlay.dataset.loaded = '1';
      } catch(err) {
        const body = overlay.querySelector('.card-body');
        // Log the error and show a clear failure message; avoid referencing undefined `data`.
        try {
          console.error('Error fetching release details for', releaseId, err);
        } catch (_e) {}
        if (body) {
          body.textContent = 'Failed to load notes.';
        }
        overlay.dataset.loaded = '1';
      }
    });
  });
});
</script>
{% endblock %}
